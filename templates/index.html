<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dividir Gastos - Split Bill</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Dividir Gastos Grupales</h1>
            <p>Gestiona y divide gastos de compras entre varias personas</p>
        </header>

        <div class="main-content">
            <!-- Secci√≥n de Personas -->
            <section class="card">
                <h2>üë• Personas</h2>
                <form action="{{ url_for('add_person') }}" method="POST" class="add-form">
                    <input type="text" name="name" placeholder="Nombre de la persona" required>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </form>

                <div class="persons-list">
                    {% if persons %}
                        {% for person in persons %}
                        <div class="person-item">
                            <span class="person-name">{{ person.name }}</span>
                            <form action="{{ url_for('remove_person', person_id=person.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-small">‚úï</button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-message">No hay personas agregadas</p>
                    {% endif %}
                </div>
            </section>

            <!-- Secci√≥n de √çtems -->
            <section class="card">
                <h2>üõí √çtems de Compra</h2>
                <form action="{{ url_for('add_item') }}" method="POST" class="add-form add-item-form">
                    <input type="text" name="name" placeholder="Nombre del √≠tem" required>
                    <input type="number" name="quantity" placeholder="Cantidad" min="1" value="1" required>
                    <input type="number" name="unit_price" placeholder="Precio Unitario" step="0.01" min="0.01" required>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </form>

                {% if items %}
                <div class="items-table-container">
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>√çtem</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Total</th>
                                {% for person in persons %}
                                <th class="person-header">{{ person.name }}</th>
                                {% endfor %}
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr>
                                <td class="item-name">{{ item.name }}</td>
                                <td class="item-quantity">{{ item.quantity }}</td>
                                <td class="item-unit-price">${{ "%.2f"|format(item.unit_price) }}</td>
                                <td class="item-cost">${{ "%.2f"|format(item.total_cost) }}</td>
                                {% for person in persons %}
                                <td class="checkbox-cell">
                                    <input type="checkbox"
                                           class="person-checkbox"
                                           data-item-id="{{ item.id }}"
                                           data-person-id="{{ person.id }}"
                                           {% if person.id in item.person_ids %}checked{% endif %}
                                           onchange="togglePersonItem({{ item.id }}, {{ person.id }})">
                                </td>
                                {% endfor %}
                                <td>
                                    <form action="{{ url_for('remove_item', item_id=item.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-danger btn-small">Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="empty-message">No hay √≠tems agregados</p>
                {% endif %}
            </section>

            <!-- Secci√≥n de Costos Compartidos -->
            <section class="card">
                <h2>ü§ù Costos Compartidos (para todos)</h2>
                <form action="{{ url_for('add_shared_cost') }}" method="POST" class="add-form">
                    <input type="text" name="name" placeholder="Nombre del costo" required>
                    <input type="number" name="cost" placeholder="Costo" step="0.01" min="0.01" required>
                    <button type="submit" class="btn btn-success">Agregar</button>
                </form>

                {% if shared_costs %}
                <div class="shared-costs-list">
                    {% for sc in shared_costs %}
                    <div class="shared-cost-item">
                        <span class="shared-name">{{ sc.name }}</span>
                        <span class="shared-cost">${{ "%.2f"|format(sc.cost) }}</span>
                        <form action="{{ url_for('remove_shared_cost', shared_cost_id=sc.id) }}" method="POST" style="display: inline;">
                            <button type="submit" class="btn btn-danger btn-small">‚úï</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                    <p class="empty-message">No hay costos compartidos</p>
                {% endif %}
            </section>

            <!-- Resumen de Totales -->
            <section class="card summary-card">
                <h2>üìä Resumen de Pagos</h2>

                {% if persons %}
                <div class="totals-container">
                    <table class="totals-table">
                        <thead>
                            <tr>
                                <th>Persona</th>
                                <th>√çtems</th>
                                <th>Compartido</th>
                                <th class="total-col">Total a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="totals-body">
                            {% for person in persons %}
                            <tr>
                                <td class="person-name-cell">{{ person.name }}</td>
                                <td class="amount-cell" id="items-{{ person.id }}">${{ "%.2f"|format(totals[person.id].items_total) }}</td>
                                <td class="amount-cell" id="shared-{{ person.id }}">${{ "%.2f"|format(totals[person.id].shared_total) }}</td>
                                <td class="total-cell" id="total-{{ person.id }}">${{ "%.2f"|format(totals[person.id].total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="grand-total-row">
                                <td colspan="3"><strong>Total General:</strong></td>
                                <td class="grand-total">${{ "%.2f"|format(grand_total) }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                    <p class="empty-message">Agrega personas para ver el resumen</p>
                {% endif %}
            </section>

            <!-- Acciones Generales -->
            <section class="actions-section">
                <form action="{{ url_for('clear_all') }}" method="POST" onsubmit="return confirm('¬øEst√°s seguro de que quieres limpiar todos los datos?');">
                    <button type="submit" class="btn btn-warning">üóëÔ∏è Limpiar Todo</button>
                </form>
            </section>
        </div>
    </div>

    <script>
        // Funci√≥n para alternar checkbox y actualizar totales
        async function togglePersonItem(itemId, personId) {
            try {
                const response = await fetch('{{ url_for("toggle_item_person") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        person_id: personId
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Actualizar los totales en la tabla
                        updateTotals(data.totals);
                    }
                } else {
                    console.error('Error al actualizar');
                    // Recargar la p√°gina si hay error
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                location.reload();
            }
        }

        // Actualizar los valores de los totales sin recargar la p√°gina
        function updateTotals(totals) {
            for (const [personId, amounts] of Object.entries(totals)) {
                const itemsCell = document.getElementById(`items-${personId}`);
                const sharedCell = document.getElementById(`shared-${personId}`);
                const totalCell = document.getElementById(`total-${personId}`);

                if (itemsCell) itemsCell.textContent = `$${amounts.items_total.toFixed(2)}`;
                if (sharedCell) sharedCell.textContent = `$${amounts.shared_total.toFixed(2)}`;
                if (totalCell) totalCell.textContent = `$${amounts.total.toFixed(2)}`;
            }
        }
    </script>
</body>
</html>

