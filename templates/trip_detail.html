<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ current_trip.name }} - Split Bill</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="{{ url_for('index') }}">‚Üê Volver a Mis Viajes</a>
        </div>

        <header>
            <h1>üí∞ {{ current_trip.name }}</h1>
            {% if current_trip.description %}
            <p>{{ current_trip.description }}</p>
            {% else %}
            <p>Gestiona y divide gastos de compras entre varias personas</p>
            {% endif %}
            <p class="trip-info-header">
                <span class="trip-date-header">Creado el {{ current_trip.created_at.strftime('%d/%m/%Y') }}</span>
                <span class="trip-days-header">üìÖ {{ current_trip.days }} d√≠a{{ 's' if current_trip.days != 1 else '' }}</span>
            </p>
        </header>

        <div class="main-content">
            <!-- Secci√≥n de Personas -->
            <section class="card persons-card">
                <h2>üë• Personas del Viaje</h2>
                <form action="{{ url_for('add_person') }}" method="POST" class="add-form persons-form">
                    <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                    <input type="text" name="name" placeholder="Nombre de la persona" required class="person-input">
                    <button type="submit" class="btn btn-primary btn-add-person">+ Agregar Persona</button>
                </form>

                <div class="persons-grid">
                    {% if persons %}
                        {% for person in persons %}
                        <div class="person-card">
                            <div class="person-avatar-large">{{ person.name[0].upper() }}</div>
                            <span class="person-name-label">{{ person.name }}</span>
                            <form action="{{ url_for('remove_person', trip_id=current_trip.id, person_id=person.id) }}" method="POST" class="remove-person-form">
                                <button type="submit" class="btn-remove-person" title="Eliminar" onclick="return confirm('¬øEliminar a {{ person.name }}?')">‚úï</button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-message">üë§ No hay personas agregadas. ¬°Agrega la primera!</p>
                    {% endif %}
                </div>
            </section>

            <!-- Costos Compartidos (General del Viaje) -->
            <section class="card shared-costs-card">
                <h2>ü§ù Costos Compartidos del Viaje</h2>
                <p class="section-description">Gastos que se dividen equitativamente entre todas las personas</p>

                <form action="{{ url_for('add_shared_cost') }}" method="POST" class="add-form shared-compact-form">
                    <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                    <input type="text" name="name" placeholder="Nombre del costo" required>
                    <input type="number" name="cost" placeholder="Costo" step="0.01" min="0.01" required>

                    <div class="paid-by-inline">
                        {% for person in persons %}
                        <label class="chip-person-small" onclick="toggleChip(this)">
                            <input type="checkbox" name="paid_by_person_ids[]" value="{{ person.id }}">
                            {{ person.name }}
                        </label>
                        {% endfor %}
                    </div>

                    <button type="submit" class="btn btn-success btn-compact">+ Agregar</button>
                </form>

                {% if shared_costs %}
                <div class="shared-costs-table-container">
                    <table class="shared-costs-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Concepto</th>
                                <th style="width: 20%;">Monto</th>
                                <th style="width: 30%;">Pagado por</th>
                                <th style="width: 15%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sc in shared_costs %}
                            <tr id="shared-row-{{ sc.id }}">
                                <td class="shared-concept">{{ sc.name }}</td>
                                <td class="shared-amount">S/. {{ "%.2f"|format(sc.cost) }}</td>
                                <td class="shared-payers">
                                    {% if sc.paid_by_person_ids %}
                                        {% for person in persons %}
                                            {% if person.id in sc.paid_by_person_ids %}
                                                <span class="payer-chip">{{ person.name }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span class="no-payer">-</span>
                                    {% endif %}
                                </td>
                                <td class="shared-actions">
                                    <button type="button" class="btn-icon btn-edit" onclick="toggleEditShared({{ sc.id }})" title="Editar">‚úèÔ∏è</button>
                                    <form action="{{ url_for('remove_shared_cost', trip_id=current_trip.id, shared_cost_id=sc.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-icon btn-delete" onclick="return confirm('¬øEliminar este costo?')" title="Eliminar">üóëÔ∏è</button>
                                    </form>
                                </td>
                            </tr>
                            <tr id="edit-shared-{{ sc.id }}" class="edit-shared-row" style="display: none;">
                                <td colspan="4" class="edit-shared-cell">
                                    <form action="{{ url_for('update_shared_cost', trip_id=current_trip.id, shared_cost_id=sc.id) }}" method="POST" class="edit-form edit-shared-inline-compact">
                                        <input type="text" name="name" value="{{ sc.name }}" placeholder="Nombre" required>
                                        <input type="number" name="cost" value="{{ sc.cost }}" placeholder="Costo" step="0.01" min="0.01" required>

                                        <div class="paid-by-inline-edit">
                                            {% for person in persons %}
                                            <label class="chip-person-small {% if person.id in sc.paid_by_person_ids %}selected{% endif %}" onclick="toggleChip(this)">
                                                <input type="checkbox" name="paid_by_person_ids[]" value="{{ person.id }}"
                                                       {% if person.id in sc.paid_by_person_ids %}checked{% endif %}>
                                                {{ person.name }}
                                            </label>
                                            {% endfor %}
                                        </div>

                                        <div class="edit-actions-compact">
                                            <button type="submit" class="btn btn-success btn-small">üíæ</button>
                                            <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditShared({{ sc.id }})">‚úñ</button>
                                        </div>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="shared-total-row">
                                <td><strong>Total Compartido</strong></td>
                                <td><strong>S/. {{ "%.2f"|format(shared_costs|sum(attribute='cost')) }}</strong></td>
                                <td colspan="2" class="shared-per-person">
                                    {% if persons %}
                                    Por persona: <strong>S/. {{ "%.2f"|format(shared_costs|sum(attribute='cost') / persons|length) }}</strong>
                                    {% endif %}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <p class="empty-message">No hay costos compartidos en este viaje</p>
                {% endif %}
            </section>

            <!-- Pesta√±as de D√≠as -->
            <section class="card days-card">
                <h2>üìÖ Gastos por D√≠a</h2>
                <p class="section-description">Organiza tus compras y gastos diarios</p>

                <!-- Navegaci√≥n de Pesta√±as -->
                <div class="tabs">
                    {% for day_data in days_data %}
                    <button class="tab-button {% if loop.first %}active{% endif %}"
                            onclick="openDay(event, 'day{{ day_data.day_number }}')">
                        D√≠a {{ day_data.day_number }}
                        <span class="tab-total">S/. {{ "%.2f"|format(day_data.day_total) }}</span>
                    </button>
                    {% endfor %}
                </div>

                <!-- Contenido de cada Pesta√±a -->
                {% for day_data in days_data %}
                <div id="day{{ day_data.day_number }}" class="tab-content {% if loop.first %}active{% endif %}">
                    <h3>D√≠a {{ day_data.day_number }}</h3>

                    <!-- Formulario de √çtems para este d√≠a -->
                    <div class="day-section">
                        <h4>üõí √çtems de Compra</h4>
                        <form action="{{ url_for('add_item') }}" method="POST" class="add-form add-item-form">
                            <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                            <input type="hidden" name="day" value="{{ day_data.day_number }}">
                            <input type="text" name="name" placeholder="Nombre del √≠tem" required>
                            <input type="number" name="quantity" placeholder="Cantidad" min="1" value="1" required>
                            <input type="number" name="unit_price" placeholder="Precio Unitario" step="0.01" min="0.01" required>
                            <input type="url" name="url" placeholder="URL (opcional)" class="url-input">
                            <select name="paid_by_person_id" class="paid-by-select">
                                <option value="">Pagado por...</option>
                                {% for person in persons %}
                                <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">Agregar</button>
                        </form>

                        {% if day_data.day_items %}
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>üì¶ √çtem</th>
                                        <th>üìä Cant.</th>
                                        <th>üíµ P.Unit.</th>
                                        <th>üí∞ Total</th>
                                        <th>üë§ Pagado por</th>
                                        <th>üîó Enlace</th>
                                        {% for person in persons %}
                                        <th class="person-header-full">{{ person.name }}</th>
                                        {% endfor %}
                                        <th>‚öôÔ∏è Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in day_data.day_items %}
                                    <tr class="item-row">
                                        <td class="item-name">{{ item.name }}</td>
                                        <td class="item-quantity">{{ item.quantity }}</td>
                                        <td class="item-unit-price">S/. {{ "%.2f"|format(item.unit_price) }}</td>
                                        <td class="item-cost">S/. {{ "%.2f"|format(item.total_cost) }}</td>
                                        <td class="paid-by-cell">
                                            {% if item.paid_by_person_id %}
                                                {% for p in persons %}
                                                    {% if p.id == item.paid_by_person_id %}
                                                        <span class="paid-by-badge-item">{{ p.name }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="no-paid">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="item-link">
                                            {% if item.url %}
                                            <a href="{{ item.url }}" target="_blank" class="btn-link-item" title="{{ item.url }}">Ver</a>
                                            {% else %}
                                            <span class="no-link">-</span>
                                            {% endif %}
                                        </td>
                                        {% for person in persons %}
                                        <td class="checkbox-cell">
                                            <input type="checkbox"
                                                   class="person-checkbox"
                                                   data-item-id="{{ item.id }}"
                                                   data-person-id="{{ person.id }}"
                                                   data-trip-id="{{ current_trip.id }}"
                                                   {% if person.id in item.person_ids %}checked{% endif %}
                                                   onchange="togglePersonItem({{ item.id }}, {{ person.id }}, {{ current_trip.id }})">
                                        </td>
                                        {% endfor %}
                                        <td class="actions-cell">
                                            <button type="button" class="btn-action-edit" onclick="toggleEditItem({{ item.id }})" title="Editar">‚úèÔ∏è</button>
                                            <form action="{{ url_for('remove_item', trip_id=current_trip.id, item_id=item.id) }}" method="POST" style="display: inline;">
                                                <button type="submit" class="btn-action-delete" onclick="return confirm('¬øEliminar este √≠tem?')" title="Eliminar">üóëÔ∏è</button>
                                            </form>
                                        </td>
                                    </tr>
                                    <!-- Fila de edici√≥n (oculta por defecto) -->
                                    <tr id="edit-row-{{ item.id }}" class="edit-row" style="display: none;">
                                        <td colspan="{{ persons|length + 6 }}" class="edit-cell">
                                            <form action="{{ url_for('update_item', trip_id=current_trip.id, item_id=item.id) }}" method="POST" class="edit-form">
                                                <div class="edit-form-grid">
                                                    <input type="text" name="name" value="{{ item.name }}" placeholder="Nombre" required>
                                                    <input type="number" name="quantity" value="{{ item.quantity }}" placeholder="Cantidad" min="1" required>
                                                    <input type="number" name="unit_price" value="{{ item.unit_price }}" placeholder="P.Unit" step="0.01" min="0.01" required>
                                                    <input type="number" name="day" value="{{ item.day }}" placeholder="D√≠a" min="1" required>
                                                    <input type="url" name="url" value="{{ item.url }}" placeholder="URL (opcional)">
                                                    <select name="paid_by_person_id">
                                                        <option value="">Pagado por...</option>
                                                        {% for p in persons %}
                                                        <option value="{{ p.id }}" {% if item.paid_by_person_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button type="submit" class="btn btn-success btn-small">Guardar</button>
                                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditItem({{ item.id }})">Cancelar</button>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="items-subtotal-row">
                                        <td class="items-subtotal-label" colspan="6">Subtotal √≠tems</td>
                                        {% for person in persons %}
                                        <td class="items-subtotal-value" data-day="{{ day_data.day_number }}" data-person="{{ person.id }}" data-type="items">
                                            S/. {{ "%.2f"|format(day_data.day_totals[person.id].items_total) }}
                                        </td>
                                        {% endfor %}
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        {% else %}
                        <p class="empty-message">No hay √≠tems en este d√≠a</p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </section>

            <!-- Resumen General del Viaje -->
            <section class="card summary-card">
                <h2>üìä Resumen General del Viaje</h2>

                {% if persons %}
                <div class="totals-container">
                    <table class="totals-table">
                        <thead>
                            <tr>
                                <th>üë§ Persona</th>
                                <th>üõí Total √çtems</th>
                                <th>ü§ù Compartido</th>
                                <th class="total-col">üí∞ Total a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="totals-body">
                            {% for person in persons %}
                            <tr class="totals-row">
                                <td class="person-name-cell">
                                    <span class="person-avatar-summary">{{ person.name[0].upper() }}</span>
                                    <span>{{ person.name }}</span>
                                </td>
                                <td class="amount-cell items-amount" id="items-{{ person.id }}">
                                    S/. {{ "%.2f"|format(totals[person.id].items_total) }}
                                </td>
                                <td class="amount-cell shared-amount" id="shared-{{ person.id }}">
                                    S/. {{ "%.2f"|format(totals[person.id].shared_total) }}
                                </td>
                                <td class="total-cell" id="total-{{ person.id }}">
                                    <span class="total-badge">S/. {{ "%.2f"|format(totals[person.id].total) }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="grand-total-row">
                                <td colspan="3"><strong>üéØ Total General del Viaje:</strong></td>
                                <td class="grand-total">S/. {{ "%.2f"|format(grand_total) }}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Verificaci√≥n de Balance -->
                    <div class="verification-panel {% if summary.is_balanced %}verified{% else %}warning{% endif %}">
                        <div class="verification-header">
                            <h3>
                                {% if summary.is_balanced %}
                                <span class="verify-icon success">‚úì</span> Balance Verificado
                                {% else %}
                                <span class="verify-icon warning">!</span> Advertencia de Balance
                                {% endif %}
                            </h3>
                            <button type="button" class="btn-refresh-verification" onclick="refreshVerification()" title="Refrescar verificaci√≥n">
                                üîÑ Refrescar
                            </button>
                        </div>
                        <div class="verification-grid">
                            <div class="verify-card">
                                <div class="verify-icon-box items">üõí</div>
                                <div class="verify-content">
                                    <span class="verify-label">Total √çtems</span>
                                    <span class="verify-value">S/. {{ "%.2f"|format(summary.total_items) }}</span>
                                </div>
                            </div>
                            <div class="verify-card">
                                <div class="verify-icon-box shared">ü§ù</div>
                                <div class="verify-content">
                                    <span class="verify-label">Total Compartido</span>
                                    <span class="verify-value">S/. {{ "%.2f"|format(summary.total_shared) }}</span>
                                </div>
                            </div>
                            <div class="verify-card highlight">
                                <div class="verify-icon-box total">üí∞</div>
                                <div class="verify-content">
                                    <span class="verify-label">Total de Gastos</span>
                                    <span class="verify-value total">S/. {{ "%.2f"|format(summary.grand_total) }}</span>
                                </div>
                            </div>
                            <div class="verify-card highlight">
                                <div class="verify-icon-box distributed">üìä</div>
                                <div class="verify-content">
                                    <span class="verify-label">Total Distribuido</span>
                                    <span class="verify-value total">S/. {{ "%.2f"|format(summary.total_distributed) }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="verification-result">
                            <div class="result-badge {% if summary.is_balanced %}success{% else %}error{% endif %}">
                                <span class="result-label">Diferencia:</span>
                                <span class="result-value">S/. {{ "%.2f"|format(summary.difference) }}</span>
                            </div>
                            {% if summary.is_balanced %}
                            <p class="verification-message success">
                                <span class="msg-icon">‚úì</span> Los totales coinciden correctamente. Todos los gastos est√°n bien distribuidos.
                            </p>
                            {% else %}
                            <p class="verification-message error">
                                <span class="msg-icon">‚ö†</span> Hay una diferencia de S/. {{ "%.2f"|format(summary.difference) }}. Verifica los datos ingresados.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                    <p class="empty-message">Agrega personas para ver el resumen</p>
                {% endif %}
            </section>

            <!-- Resumen de Pagos (Qui√©n pag√≥ y cu√°nto se le debe) -->
            <section class="card payments-card">
                <h2>üí≥ Resumen de Pagos</h2>

                {% if persons and payments_summary %}
                <div class="payments-container">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>üë§ Persona</th>
                                <th>üí∞ Pag√≥</th>
                                <th>üßæ Debe</th>
                                <th class="balance-col">‚öñÔ∏è Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for person in persons %}
                            <tr class="payment-row">
                                <td class="person-name-cell">
                                    <span class="person-avatar">{{ person.name[0].upper() }}</span>
                                    <span>{{ person.name }}</span>
                                </td>
                                <td class="paid-cell">S/. {{ "%.2f"|format(payments_summary[person.id].total_paid) }}</td>
                                <td class="owes-cell">S/. {{ "%.2f"|format(payments_summary[person.id].total_owes) }}</td>
                                <td class="balance-cell {% if payments_summary[person.id].balance > 0 %}positive{% elif payments_summary[person.id].balance < 0 %}negative{% else %}zero{% endif %}">
                                    {% if payments_summary[person.id].balance > 0 %}
                                        <div class="balance-content">
                                            <span class="balance-amount balance-positive">+S/. {{ "%.2f"|format(payments_summary[person.id].balance) }}</span>
                                            <span class="balance-badge positive-badge">Le deben</span>
                                        </div>
                                    {% elif payments_summary[person.id].balance < 0 %}
                                        <div class="balance-content">
                                            <span class="balance-amount balance-negative">-S/. {{ "%.2f"|format(payments_summary[person.id].balance|abs) }}</span>
                                            <span class="balance-badge negative-badge">Debe</span>
                                        </div>
                                    {% else %}
                                        <div class="balance-content">
                                            <span class="balance-amount balance-zero">S/. 0.00</span>
                                            <span class="balance-badge zero-badge">A mano</span>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="payments-explanation">
                        <h4>üí° Gu√≠a r√°pida:</h4>
                        <div class="explanation-grid">
                            <div class="explanation-item">
                                <span class="explanation-icon">üí∞</span>
                                <div>
                                    <strong>Pag√≥</strong>
                                    <p>Dinero desembolsado</p>
                                </div>
                            </div>
                            <div class="explanation-item">
                                <span class="explanation-icon">üßæ</span>
                                <div>
                                    <strong>Debe</strong>
                                    <p>Total por consumo</p>
                                </div>
                            </div>
                            <div class="explanation-item positive">
                                <span class="explanation-icon">‚úÖ</span>
                                <div>
                                    <strong>Le deben</strong>
                                    <p>Pag√≥ de m√°s</p>
                                </div>
                            </div>
                            <div class="explanation-item negative">
                                <span class="explanation-icon">‚ùå</span>
                                <div>
                                    <strong>Debe</strong>
                                    <p>Consumi√≥ m√°s</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                    <p class="empty-message">Agrega personas y marca qui√©n pag√≥ los √≠tems para ver el resumen</p>
                {% endif %}
            </section>

            <!-- Acciones Generales -->
            <section class="actions-section">
                <form action="{{ url_for('clear_all', trip_id=current_trip.id) }}" method="POST" onsubmit="return confirm('¬øEst√°s seguro de que quieres limpiar todos los datos de este viaje?');">
                    <button type="submit" class="btn btn-warning">üóëÔ∏è Limpiar Todo</button>
                </form>
            </section>
        </div>
    </div>

    <!-- Loader Overlay -->
    <div class="loader-overlay" id="globalLoader">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Cargando...</p>
        </div>
    </div>

    <script>
        // Funciones del Loader
        function showLoader(message = 'Cargando...') {
            const loader = document.getElementById('globalLoader');
            const loaderText = loader.querySelector('.loader-text');
            loaderText.textContent = message;
            loader.classList.add('show');
        }

        function hideLoader() {
            const loader = document.getElementById('globalLoader');
            loader.classList.remove('show');
        }

        // Mostrar loader autom√°ticamente en todos los formularios
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                // No aplicar loader a formularios de edici√≥n inline
                if (!form.classList.contains('edit-form')) {
                    form.addEventListener('submit', function(e) {
                        // Verificar si el formulario requiere confirmaci√≥n
                        const hasConfirm = form.getAttribute('onsubmit') && form.getAttribute('onsubmit').includes('confirm');
                        if (!hasConfirm) {
                            showLoader('Procesando...');
                        } else {
                            // Para formularios con confirmaci√≥n, mostrar loader solo si se confirma
                            const originalOnsubmit = form.getAttribute('onsubmit');
                            form.setAttribute('onsubmit', originalOnsubmit.replace('return confirm', 'if (confirm') + ') { showLoader("Procesando..."); return true; } return false;');
                        }
                    });
                }
            });
        });

        // Toggle chip de persona (pagado por)
        function toggleChip(chipElement) {
            const checkbox = chipElement.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            chipElement.classList.toggle('selected', checkbox.checked);
        }

        // Mostrar/ocultar formulario de edici√≥n de √≠tem
        function toggleEditItem(itemId) {
            const editRow = document.getElementById(`edit-row-${itemId}`);
            if (editRow.style.display === 'none') {
                editRow.style.display = 'table-row';
            } else {
                editRow.style.display = 'none';
            }
        }

        // Mostrar/ocultar formulario de edici√≥n de costo compartido
        function toggleEditShared(sharedId) {
            const editRow = document.getElementById(`edit-shared-${sharedId}`);
            if (editRow) {
                if (editRow.style.display === 'none' || editRow.style.display === '') {
                    editRow.style.display = 'table-row';
                } else {
                    editRow.style.display = 'none';
                }
            }
        }

        // Sistema de pesta√±as
        function openDay(evt, dayId) {
            var tabContents = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            var tabButtons = document.getElementsByClassName("tab-button");
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            document.getElementById(dayId).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Alternar checkbox y actualizar SOLO los totales (sin recargar)
        async function togglePersonItem(itemId, personId, tripId) {
            showLoader('Actualizando...');
            try {
                const response = await fetch('{{ url_for("toggle_item_person") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId, person_id: personId, trip_id: tripId })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Actualizar resumen general
                        updateGeneralSummary(data.totals, data.grand_total, data.summary);

                        // Actualizar totales de cada d√≠a
                        if (data.days_totals) {
                            updateDaysSummaries(data.days_totals);
                        }
                        hideLoader();
                    } else {
                        location.reload();
                    }
                } else {
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                location.reload();
            }
        }

        // Actualizar resumen general
        function updateGeneralSummary(totals, grandTotal, summary) {
            // Actualizar tabla de totales
            for (const [personId, amounts] of Object.entries(totals)) {
                const cells = {
                    items: document.getElementById(`items-${personId}`),
                    shared: document.getElementById(`shared-${personId}`),
                    total: document.getElementById(`total-${personId}`)
                };

                if (cells.items) cells.items.textContent = `S/. ${amounts.items_total.toFixed(2)}`;
                if (cells.shared) cells.shared.textContent = `S/. ${amounts.shared_total.toFixed(2)}`;
                if (cells.total) cells.total.textContent = `S/. ${amounts.total.toFixed(2)}`;
            }

            // Actualizar grand total
            const grandTotalCell = document.querySelector('.grand-total');
            if (grandTotalCell) grandTotalCell.textContent = `S/. ${grandTotal.toFixed(2)}`;

            // Actualizar panel de verificaci√≥n
            if (summary) {
                const verificationValues = {
                    'Total √çtems': summary.total_items,
                    'Total Compartido': summary.total_shared,
                    'Total de Gastos': summary.grand_total,
                    'Total Distribuido': summary.total_distributed,
                    'Diferencia': summary.difference
                };

                document.querySelectorAll('.verification-item').forEach(item => {
                    const label = item.querySelector('.verification-label');
                    const value = item.querySelector('.verification-value');

                    if (label && value) {
                        for (const [key, val] of Object.entries(verificationValues)) {
                            if (label.textContent.includes(key)) {
                                value.textContent = `S/. ${val.toFixed(2)}`;
                                if (key === 'Diferencia') {
                                    value.className = 'verification-value ' + (summary.is_balanced ? 'balanced' : 'unbalanced');
                                }
                            }
                        }
                    }
                });

                const panel = document.querySelector('.verification-panel');
                if (panel) panel.className = 'verification-panel ' + (summary.is_balanced ? 'verified' : 'warning');
            }
        }

        // Actualizar res√∫menes de cada d√≠a
        function updateDaysSummaries(daysTotals) {
            for (const [day, dayData] of Object.entries(daysTotals)) {
                // Actualizar total en la pesta√±a
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.textContent.includes(`D√≠a ${day}`)) {
                        const totalSpan = btn.querySelector('.tab-total');
                        if (totalSpan) totalSpan.textContent = `S/. ${dayData.day_total.toFixed(2)}`;
                    }
                });

                const dayContent = document.getElementById(`day${day}`);
                if (dayContent && dayData.totals) {
                    // Actualizar subtotales en el footer de la tabla de √≠tems usando data attributes
                    for (const [personId, amounts] of Object.entries(dayData.totals)) {
                        // Subtotal √≠tems
                        const itemsCell = dayContent.querySelector(`td[data-day="${day}"][data-person="${personId}"][data-type="items"]`);
                        if (itemsCell) itemsCell.textContent = `S/. ${amounts.items_total.toFixed(2)}`;
                    }

                    // Actualizar tabla de resumen del d√≠a (la tabla separada de resumen)
                    const table = dayContent.querySelector('.day-totals-table tbody');
                    if (table) {
                        const rows = table.querySelectorAll('tr');
                        let idx = 0;
                        for (const [personId, amounts] of Object.entries(dayData.totals)) {
                            if (rows[idx]) {
                                const cells = rows[idx].querySelectorAll('td');
                                if (cells.length >= 4) {
                                    cells[1].textContent = `S/. ${amounts.items_total.toFixed(2)}`;
                                    cells[2].textContent = `S/. ${amounts.shared_total.toFixed(2)}`;
                                    cells[3].textContent = `S/. ${amounts.total.toFixed(2)}`;
                                }
                            }
                            idx++;
                        }
                    }

                    // Actualizar total del d√≠a en footer
                    const footer = dayContent.querySelector('.day-grand-total');
                    if (footer) footer.textContent = `S/. ${dayData.day_total.toFixed(2)}`;
                }
            }
        }

        // Refrescar verificaci√≥n de balance
        function refreshVerification() {
            showLoader('Actualizando verificaci√≥n...');
            // Recargar la p√°gina completa para obtener datos actualizados
            window.location.reload();
        }
    </script>
</body>
</html>
