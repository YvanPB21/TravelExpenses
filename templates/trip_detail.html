<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ current_trip.name }} - Split Bill</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="{{ url_for('index') }}">‚Üê Volver a Mis Viajes</a>
        </div>

        <header>
            <h1>üí∞ {{ current_trip.name }}</h1>
            {% if current_trip.description %}
            <p>{{ current_trip.description }}</p>
            {% else %}
            <p>Gestiona y divide gastos de compras entre varias personas</p>
            {% endif %}
            <p class="trip-info-header">
                <span class="trip-date-header">Creado el {{ current_trip.created_at.strftime('%d/%m/%Y') }}</span>
                <span class="trip-days-header">üìÖ {{ current_trip.days }} d√≠a{{ 's' if current_trip.days != 1 else '' }}</span>
            </p>
        </header>

        <div class="main-content">
            <!-- Secci√≥n de Personas -->
            <section class="card">
                <h2>üë• Personas</h2>
                <form action="{{ url_for('add_person') }}" method="POST" class="add-form">
                    <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                    <input type="text" name="name" placeholder="Nombre de la persona" required>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </form>

                <div class="persons-list">
                    {% if persons %}
                        {% for person in persons %}
                        <div class="person-item">
                            <span class="person-name">{{ person.name }}</span>
                            <form action="{{ url_for('remove_person', trip_id=current_trip.id, person_id=person.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-small">‚úï</button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-message">No hay personas agregadas</p>
                    {% endif %}
                </div>
            </section>

            <!-- Pesta√±as de D√≠as -->
            <section class="card">
                <h2>üìÖ Gastos por D√≠a</h2>

                <!-- Navegaci√≥n de Pesta√±as -->
                <div class="tabs">
                    {% for day_data in days_data %}
                    <button class="tab-button {% if loop.first %}active{% endif %}"
                            onclick="openDay(event, 'day{{ day_data.day_number }}')">
                        D√≠a {{ day_data.day_number }}
                        <span class="tab-total">${{ "%.2f"|format(day_data.day_total) }}</span>
                    </button>
                    {% endfor %}
                </div>

                <!-- Contenido de cada Pesta√±a -->
                {% for day_data in days_data %}
                <div id="day{{ day_data.day_number }}" class="tab-content {% if loop.first %}active{% endif %}">
                    <h3>D√≠a {{ day_data.day_number }}</h3>

                    <!-- Formulario de √çtems para este d√≠a -->
                    <div class="day-section">
                        <h4>üõí √çtems de Compra</h4>
                        <form action="{{ url_for('add_item') }}" method="POST" class="add-form add-item-form">
                            <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                            <input type="hidden" name="day" value="{{ day_data.day_number }}">
                            <input type="text" name="name" placeholder="Nombre del √≠tem" required>
                            <input type="number" name="quantity" placeholder="Cantidad" min="1" value="1" required>
                            <input type="number" name="unit_price" placeholder="Precio Unitario" step="0.01" min="0.01" required>
                            <input type="url" name="url" placeholder="URL (opcional)" class="url-input">
                            <button type="submit" class="btn btn-primary">Agregar</button>
                        </form>

                        {% if day_data.day_items %}
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>√çtem</th>
                                        <th>Cant.</th>
                                        <th>P.Unit.</th>
                                        <th>Total</th>
                                        <th>Enlace</th>
                                        {% for person in persons %}
                                        <th class="person-header">{{ person.name }}</th>
                                        {% endfor %}
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in day_data.day_items %}
                                    <tr>
                                        <td class="item-name">{{ item.name }}</td>
                                        <td class="item-quantity">{{ item.quantity }}</td>
                                        <td class="item-unit-price">${{ "%.2f"|format(item.unit_price) }}</td>
                                        <td class="item-cost">${{ "%.2f"|format(item.total_cost) }}</td>
                                        <td class="item-link">
                                            {% if item.url %}
                                            <a href="{{ item.url }}" target="_blank" class="btn-link" title="{{ item.url }}">üîó Ver</a>
                                            {% else %}
                                            <span class="no-link">-</span>
                                            {% endif %}
                                        </td>
                                        {% for person in persons %}
                                        <td class="checkbox-cell">
                                            <input type="checkbox"
                                                   class="person-checkbox"
                                                   data-item-id="{{ item.id }}"
                                                   data-person-id="{{ person.id }}"
                                                   data-trip-id="{{ current_trip.id }}"
                                                   {% if person.id in item.person_ids %}checked{% endif %}
                                                   onchange="togglePersonItem({{ item.id }}, {{ person.id }}, {{ current_trip.id }})">
                                        </td>
                                        {% endfor %}
                                        <td>
                                            <form action="{{ url_for('remove_item', trip_id=current_trip.id, item_id=item.id) }}" method="POST" style="display: inline;">
                                                <button type="submit" class="btn btn-danger btn-small">Eliminar</button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="empty-message">No hay √≠tems en este d√≠a</p>
                        {% endif %}
                    </div>

                    <!-- Costos Compartidos del d√≠a -->
                    <div class="day-section">
                        <h4>ü§ù Costos Compartidos</h4>
                        <form action="{{ url_for('add_shared_cost') }}" method="POST" class="add-form">
                            <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                            <input type="hidden" name="day" value="{{ day_data.day_number }}">
                            <input type="text" name="name" placeholder="Nombre del costo" required>
                            <input type="number" name="cost" placeholder="Costo" step="0.01" min="0.01" required>
                            <button type="submit" class="btn btn-success">Agregar</button>
                        </form>

                        {% if day_data.day_shared_costs %}
                        <div class="shared-costs-list">
                            {% for sc in day_data.day_shared_costs %}
                            <div class="shared-cost-item">
                                <span class="shared-name">{{ sc.name }}</span>
                                <span class="shared-cost">${{ "%.2f"|format(sc.cost) }}</span>
                                <form action="{{ url_for('remove_shared_cost', trip_id=current_trip.id, shared_cost_id=sc.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-danger btn-small">‚úï</button>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="empty-message">No hay costos compartidos en este d√≠a</p>
                        {% endif %}
                    </div>

                    <!-- Resumen del D√≠a -->
                    {% if persons %}
                    <div class="day-summary">
                        <h4>üìä Resumen del D√≠a {{ day_data.day_number }}</h4>
                        <table class="day-totals-table">
                            <thead>
                                <tr>
                                    <th>Persona</th>
                                    <th>√çtems</th>
                                    <th>Compartido</th>
                                    <th>Total D√≠a</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for person in persons %}
                                <tr>
                                    <td>{{ person.name }}</td>
                                    <td>${{ "%.2f"|format(day_data.day_totals[person.id].items_total) }}</td>
                                    <td>${{ "%.2f"|format(day_data.day_totals[person.id].shared_total) }}</td>
                                    <td class="day-total-cell">${{ "%.2f"|format(day_data.day_totals[person.id].total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total del D√≠a:</strong></td>
                                    <td class="day-grand-total">${{ "%.2f"|format(day_data.day_total) }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </section>

            <!-- Resumen General del Viaje -->
            <section class="card summary-card">
                <h2>üìä Resumen General del Viaje</h2>

                {% if persons %}
                <div class="totals-container">
                    <table class="totals-table">
                        <thead>
                            <tr>
                                <th>Persona</th>
                                <th>Total √çtems</th>
                                <th>Total Compartido</th>
                                <th class="total-col">Total a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="totals-body">
                            {% for person in persons %}
                            <tr>
                                <td class="person-name-cell">{{ person.name }}</td>
                                <td class="amount-cell" id="items-{{ person.id }}">${{ "%.2f"|format(totals[person.id].items_total) }}</td>
                                <td class="amount-cell" id="shared-{{ person.id }}">${{ "%.2f"|format(totals[person.id].shared_total) }}</td>
                                <td class="total-cell" id="total-{{ person.id }}">${{ "%.2f"|format(totals[person.id].total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="grand-total-row">
                                <td colspan="3"><strong>Total General del Viaje:</strong></td>
                                <td class="grand-total">${{ "%.2f"|format(grand_total) }}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Verificaci√≥n de Balance -->
                    <div class="verification-panel {% if summary.is_balanced %}verified{% else %}warning{% endif %}">
                        <h3>
                            {% if summary.is_balanced %}
                            ‚úÖ Balance Verificado
                            {% else %}
                            ‚ö†Ô∏è Advertencia de Balance
                            {% endif %}
                        </h3>
                        <div class="verification-details">
                            <div class="verification-item">
                                <span class="verification-label">Total √çtems:</span>
                                <span class="verification-value">${{ "%.2f"|format(summary.total_items) }}</span>
                            </div>
                            <div class="verification-item">
                                <span class="verification-label">Total Compartido:</span>
                                <span class="verification-value">${{ "%.2f"|format(summary.total_shared) }}</span>
                            </div>
                            <div class="verification-item">
                                <span class="verification-label">Total de Gastos:</span>
                                <span class="verification-value total-highlight">${{ "%.2f"|format(summary.grand_total) }}</span>
                            </div>
                            <div class="verification-item">
                                <span class="verification-label">Total Distribuido:</span>
                                <span class="verification-value total-highlight">${{ "%.2f"|format(summary.total_distributed) }}</span>
                            </div>
                            <div class="verification-item final">
                                <span class="verification-label">Diferencia:</span>
                                <span class="verification-value {% if summary.is_balanced %}balanced{% else %}unbalanced{% endif %}">
                                    ${{ "%.2f"|format(summary.difference) }}
                                </span>
                            </div>
                            {% if summary.is_balanced %}
                            <p class="verification-message success">
                                ‚úì Los totales coinciden correctamente. Todos los gastos est√°n bien distribuidos.
                            </p>
                            {% else %}
                            <p class="verification-message error">
                                ‚ö† Hay una diferencia de ${{ "%.2f"|format(summary.difference) }}. Verifica los datos ingresados.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                    <p class="empty-message">Agrega personas para ver el resumen</p>
                {% endif %}
            </section>

            <!-- Acciones Generales -->
            <section class="actions-section">
                <form action="{{ url_for('clear_all', trip_id=current_trip.id) }}" method="POST" onsubmit="return confirm('¬øEst√°s seguro de que quieres limpiar todos los datos de este viaje?');">
                    <button type="submit" class="btn btn-warning">üóëÔ∏è Limpiar Todo</button>
                </form>
            </section>
        </div>
    </div>

    <script>
        // Sistema de pesta√±as
        function openDay(evt, dayId) {
            // Ocultar todo el contenido de pesta√±as
            var tabContents = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            // Remover clase active de todos los botones
            var tabButtons = document.getElementsByClassName("tab-button");
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            // Mostrar el contenido actual y marcar el bot√≥n como activo
            document.getElementById(dayId).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Funci√≥n para alternar checkbox y recargar p√°gina
        async function togglePersonItem(itemId, personId, tripId) {
            try {
                const response = await fetch('{{ url_for("toggle_item_person") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        item_id: itemId,
                        person_id: personId,
                        trip_id: tripId
                    })
                });

                if (response.ok) {
                    // Recargar la p√°gina para mostrar cambios
                    location.reload();
                } else {
                    console.error('Error al actualizar');
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                location.reload();
            }
        }
    </script>
</body>
</html>

