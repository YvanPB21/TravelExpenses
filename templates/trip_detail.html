<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ current_trip.name }} - Split Bill</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="{{ url_for('index') }}">‚Üê Volver a Mis Viajes</a>
        </div>

        <header>
            <h1>üí∞ {{ current_trip.name }}</h1>
            {% if current_trip.description %}
            <p>{{ current_trip.description }}</p>
            {% else %}
            <p>Gestiona y divide gastos de compras entre varias personas</p>
            {% endif %}
            <p class="trip-info-header">
                <span class="trip-date-header">Creado el {{ current_trip.created_at.strftime('%d/%m/%Y') }}</span>
                <span class="trip-days-header">üìÖ {{ current_trip.days }} d√≠a{{ 's' if current_trip.days != 1 else '' }}</span>
            </p>
        </header>

        <div class="main-content">
            <!-- Secci√≥n de Personas -->
            <section class="card">
                <h2>üë• Personas</h2>
                <form action="{{ url_for('add_person') }}" method="POST" class="add-form">
                    <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                    <input type="text" name="name" placeholder="Nombre de la persona" required>
                    <button type="submit" class="btn btn-primary">Agregar</button>
                </form>

                <div class="persons-list">
                    {% if persons %}
                        {% for person in persons %}
                        <div class="person-item">
                            <span class="person-name">{{ person.name }}</span>
                            <form action="{{ url_for('remove_person', trip_id=current_trip.id, person_id=person.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-danger btn-small">‚úï</button>
                            </form>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="empty-message">No hay personas agregadas</p>
                    {% endif %}
                </div>
            </section>

            <!-- Pesta√±as de D√≠as -->
            <section class="card">
                <h2>üìÖ Gastos por D√≠a</h2>

                <!-- Navegaci√≥n de Pesta√±as -->
                <div class="tabs">
                    {% for day_data in days_data %}
                    <button class="tab-button {% if loop.first %}active{% endif %}"
                            onclick="openDay(event, 'day{{ day_data.day_number }}')">
                        D√≠a {{ day_data.day_number }}
                        <span class="tab-total">${{ "%.2f"|format(day_data.day_total) }}</span>
                    </button>
                    {% endfor %}
                </div>

                <!-- Contenido de cada Pesta√±a -->
                {% for day_data in days_data %}
                <div id="day{{ day_data.day_number }}" class="tab-content {% if loop.first %}active{% endif %}">
                    <h3>D√≠a {{ day_data.day_number }}</h3>

                    <!-- Formulario de √çtems para este d√≠a -->
                    <div class="day-section">
                        <h4>üõí √çtems de Compra</h4>
                        <form action="{{ url_for('add_item') }}" method="POST" class="add-form add-item-form">
                            <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                            <input type="hidden" name="day" value="{{ day_data.day_number }}">
                            <input type="text" name="name" placeholder="Nombre del √≠tem" required>
                            <input type="number" name="quantity" placeholder="Cantidad" min="1" value="1" required>
                            <input type="number" name="unit_price" placeholder="Precio Unitario" step="0.01" min="0.01" required>
                            <input type="url" name="url" placeholder="URL (opcional)" class="url-input">
                            <select name="paid_by_person_id" class="paid-by-select">
                                <option value="">Pagado por...</option>
                                {% for person in persons %}
                                <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary">Agregar</button>
                        </form>

                        {% if day_data.day_items %}
                        <div class="items-table-container">
                            <table class="items-table">
                                <thead>
                                    <tr>
                                        <th>√çtem</th>
                                        <th>Cant.</th>
                                        <th>P.Unit.</th>
                                        <th>Total</th>
                                        <th>Pagado por</th>
                                        <th>Enlace</th>
                                        {% for person in persons %}
                                        <th class="person-header">{{ person.name }}</th>
                                        {% endfor %}
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in day_data.day_items %}
                                    <tr>
                                        <td class="item-name">{{ item.name }}</td>
                                        <td class="item-quantity">{{ item.quantity }}</td>
                                        <td class="item-unit-price">${{ "%.2f"|format(item.unit_price) }}</td>
                                        <td class="item-cost">${{ "%.2f"|format(item.total_cost) }}</td>
                                        <td class="paid-by-cell">
                                            {% if item.paid_by_person_id %}
                                                {% for p in persons %}
                                                    {% if p.id == item.paid_by_person_id %}
                                                        <span class="paid-by-badge">{{ p.name }}</span>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="no-paid">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="item-link">
                                            {% if item.url %}
                                            <a href="{{ item.url }}" target="_blank" class="btn-link" title="{{ item.url }}">üîó Ver</a>
                                            {% else %}
                                            <span class="no-link">-</span>
                                            {% endif %}
                                        </td>
                                        {% for person in persons %}
                                        <td class="checkbox-cell">
                                            <input type="checkbox"
                                                   class="person-checkbox"
                                                   data-item-id="{{ item.id }}"
                                                   data-person-id="{{ person.id }}"
                                                   data-trip-id="{{ current_trip.id }}"
                                                   {% if person.id in item.person_ids %}checked{% endif %}
                                                   onchange="togglePersonItem({{ item.id }}, {{ person.id }}, {{ current_trip.id }})">
                                        </td>
                                        {% endfor %}
                                        <td>
                                            <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditItem({{ item.id }})">Editar</button>
                                            <form action="{{ url_for('remove_item', trip_id=current_trip.id, item_id=item.id) }}" method="POST" style="display: inline;">
                                                <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('¬øEliminar este √≠tem?')">Eliminar</button>
                                            </form>
                                        </td>
                                    </tr>
                                    <!-- Fila de edici√≥n (oculta por defecto) -->
                                    <tr id="edit-row-{{ item.id }}" class="edit-row" style="display: none;">
                                        <td colspan="{{ persons|length + 6 }}" class="edit-cell">
                                            <form action="{{ url_for('update_item', trip_id=current_trip.id, item_id=item.id) }}" method="POST" class="edit-form">
                                                <div class="edit-form-grid">
                                                    <input type="text" name="name" value="{{ item.name }}" placeholder="Nombre" required>
                                                    <input type="number" name="quantity" value="{{ item.quantity }}" placeholder="Cantidad" min="1" required>
                                                    <input type="number" name="unit_price" value="{{ item.unit_price }}" placeholder="P.Unit" step="0.01" min="0.01" required>
                                                    <input type="number" name="day" value="{{ item.day }}" placeholder="D√≠a" min="1" required>
                                                    <input type="url" name="url" value="{{ item.url }}" placeholder="URL (opcional)">
                                                    <select name="paid_by_person_id">
                                                        <option value="">Pagado por...</option>
                                                        {% for p in persons %}
                                                        <option value="{{ p.id }}" {% if item.paid_by_person_id == p.id %}selected{% endif %}>{{ p.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                    <button type="submit" class="btn btn-success btn-small">Guardar</button>
                                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditItem({{ item.id }})">Cancelar</button>
                                                </div>
                                            </form>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="empty-message">No hay √≠tems en este d√≠a</p>
                        {% endif %}
                    </div>

                    <!-- Costos Compartidos del d√≠a -->
                    <div class="day-section">
                        <h4>ü§ù Costos Compartidos</h4>
                        <form action="{{ url_for('add_shared_cost') }}" method="POST" class="add-form">
                            <input type="hidden" name="trip_id" value="{{ current_trip.id }}">
                            <input type="hidden" name="day" value="{{ day_data.day_number }}">
                            <input type="text" name="name" placeholder="Nombre del costo" required>
                            <input type="number" name="cost" placeholder="Costo" step="0.01" min="0.01" required>
                            
                            <!-- Chips seleccionables de "Pagado por" -->
                            <div class="paid-by-chips-container" style="flex: 1 1 100%;">
                                <label class="paid-by-label">üí≥ Pagado por (selecciona una o m√°s personas):</label>
                                <div class="chips-wrapper">
                                    {% for person in persons %}
                                    <label class="chip-person" onclick="toggleChip(this)">
                                        <input type="checkbox" name="paid_by_person_ids[]" value="{{ person.id }}">
                                        {{ person.name }}
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-success">Agregar</button>
                        </form>

                        {% if day_data.day_shared_costs %}
                        <div class="shared-costs-list">
                            {% for sc in day_data.day_shared_costs %}
                            <div class="shared-cost-item" id="shared-item-{{ sc.id }}">
                                <div class="shared-cost-info">
                                    <span class="shared-name">{{ sc.name }}</span>
                                    <span class="shared-cost">${{ "%.2f"|format(sc.cost) }}</span>
                                    <div class="shared-paid-by">
                                        {% if sc.paid_by_person_ids %}
                                            <span class="paid-by-label-small">üí≥</span>
                                            {% for person in persons %}
                                                {% if person.id in sc.paid_by_person_ids %}
                                                    <span class="paid-by-badge">{{ person.name }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="no-paid-badge">Sin registrar</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="shared-cost-actions">
                                    <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditShared({{ sc.id }})">Editar</button>
                                    <form action="{{ url_for('remove_shared_cost', trip_id=current_trip.id, shared_cost_id=sc.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-danger btn-small" onclick="return confirm('¬øEliminar este costo compartido?')">Eliminar</button>
                                    </form>
                                </div>
                            </div>
                            <!-- Formulario de edici√≥n (oculto por defecto) -->
                            <div id="edit-shared-{{ sc.id }}" class="edit-shared-form" style="display: none;">
                                <form action="{{ url_for('update_shared_cost', trip_id=current_trip.id, shared_cost_id=sc.id) }}" method="POST" class="edit-form">
                                    <div class="edit-form-grid">
                                        <input type="text" name="name" value="{{ sc.name }}" placeholder="Nombre" required>
                                        <input type="number" name="cost" value="{{ sc.cost }}" placeholder="Costo" step="0.01" min="0.01" required>
                                        <input type="number" name="day" value="{{ sc.day }}" placeholder="D√≠a" min="1" required>
                                        
                                        <!-- Chips de "Pagado por" en edici√≥n -->
                                        <div class="paid-by-chips-edit">
                                            <label class="paid-by-label">üí≥ Pagado por:</label>
                                            <div class="chips-wrapper">
                                                {% for person in persons %}
                                                <label class="chip-person {% if person.id in sc.paid_by_person_ids %}selected{% endif %}" onclick="toggleChip(this)">
                                                    <input type="checkbox" name="paid_by_person_ids[]" value="{{ person.id }}"
                                                           {% if person.id in sc.paid_by_person_ids %}checked{% endif %}>
                                                    {{ person.name }}
                                                </label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-success btn-small">Guardar</button>
                                        <button type="button" class="btn btn-secondary btn-small" onclick="toggleEditShared({{ sc.id }})">Cancelar</button>
                                    </div>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="empty-message">No hay costos compartidos en este d√≠a</p>
                        {% endif %}
                    </div>

                    <!-- Resumen del D√≠a -->
                    {% if persons %}
                    <div class="day-summary">
                        <h4>üìä Resumen del D√≠a {{ day_data.day_number }}</h4>
                        <table class="day-totals-table">
                            <thead>
                                <tr>
                                    <th>Persona</th>
                                    <th>√çtems</th>
                                    <th>Compartido</th>
                                    <th>Total D√≠a</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for person in persons %}
                                <tr>
                                    <td>{{ person.name }}</td>
                                    <td>${{ "%.2f"|format(day_data.day_totals[person.id].items_total) }}</td>
                                    <td>${{ "%.2f"|format(day_data.day_totals[person.id].shared_total) }}</td>
                                    <td class="day-total-cell">${{ "%.2f"|format(day_data.day_totals[person.id].total) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total del D√≠a:</strong></td>
                                    <td class="day-grand-total">${{ "%.2f"|format(day_data.day_total) }}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </section>

            <!-- Resumen General del Viaje -->
            <section class="card summary-card">
                <h2>üìä Resumen General del Viaje</h2>

                {% if persons %}
                <div class="totals-container">
                    <table class="totals-table">
                        <thead>
                            <tr>
                                <th>Persona</th>
                                <th>Total √çtems</th>
                                <th>Total Compartido</th>
                                <th class="total-col">Total a Pagar</th>
                            </tr>
                        </thead>
                        <tbody id="totals-body">
                            {% for person in persons %}
                            <tr>
                                <td class="person-name-cell">{{ person.name }}</td>
                                <td class="amount-cell" id="items-{{ person.id }}">${{ "%.2f"|format(totals[person.id].items_total) }}</td>
                                <td class="amount-cell" id="shared-{{ person.id }}">${{ "%.2f"|format(totals[person.id].shared_total) }}</td>
                                <td class="total-cell" id="total-{{ person.id }}">${{ "%.2f"|format(totals[person.id].total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="grand-total-row">
                                <td colspan="3"><strong>Total General del Viaje:</strong></td>
                                <td class="grand-total">${{ "%.2f"|format(grand_total) }}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Verificaci√≥n de Balance -->
                    <div class="verification-panel {% if summary.is_balanced %}verified{% else %}warning{% endif %}">
                        <h3>
                            {% if summary.is_balanced %}
                            ‚úÖ Balance Verificado
                            {% else %}
                            ‚ö†Ô∏è Advertencia de Balance
                            {% endif %}
                        </h3>
                        <div class="verification-details">
                            <div class="verification-item">
                                <span class="verification-label">Total √çtems:</span>
                                <span class="verification-value">${{ "%.2f"|format(summary.total_items) }}</span>
                            </div>
                            <div class="verification-item">
                                <span class="verification-label">Total Compartido:</span>
                                <span class="verification-value">${{ "%.2f"|format(summary.total_shared) }}</span>
                            </div>
                            <div class="verification-item">
                                <span class="verification-label">Total de Gastos:</span>
                                <span class="verification-value total-highlight">${{ "%.2f"|format(summary.grand_total) }}</span>
                            </div>
                            <div class="verification-item">
                                <span class="verification-label">Total Distribuido:</span>
                                <span class="verification-value total-highlight">${{ "%.2f"|format(summary.total_distributed) }}</span>
                            </div>
                            <div class="verification-item final">
                                <span class="verification-label">Diferencia:</span>
                                <span class="verification-value {% if summary.is_balanced %}balanced{% else %}unbalanced{% endif %}">
                                    ${{ "%.2f"|format(summary.difference) }}
                                </span>
                            </div>
                            {% if summary.is_balanced %}
                            <p class="verification-message success">
                                ‚úì Los totales coinciden correctamente. Todos los gastos est√°n bien distribuidos.
                            </p>
                            {% else %}
                            <p class="verification-message error">
                                ‚ö† Hay una diferencia de ${{ "%.2f"|format(summary.difference) }}. Verifica los datos ingresados.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                    <p class="empty-message">Agrega personas para ver el resumen</p>
                {% endif %}
            </section>

            <!-- Resumen de Pagos (Qui√©n pag√≥ y cu√°nto se le debe) -->
            <section class="card payments-card">
                <h2>üí≥ Resumen de Pagos</h2>

                {% if persons and payments_summary %}
                <div class="payments-container">
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>Persona</th>
                                <th>Pag√≥</th>
                                <th>Debe (Consumo)</th>
                                <th class="balance-col">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for person in persons %}
                            <tr>
                                <td class="person-name-cell">{{ person.name }}</td>
                                <td class="paid-cell">${{ "%.2f"|format(payments_summary[person.id].total_paid) }}</td>
                                <td class="owes-cell">${{ "%.2f"|format(payments_summary[person.id].total_owes) }}</td>
                                <td class="balance-cell {% if payments_summary[person.id].balance > 0 %}positive{% elif payments_summary[person.id].balance < 0 %}negative{% else %}zero{% endif %}">
                                    {% if payments_summary[person.id].balance > 0 %}
                                        <span class="balance-positive">+${{ "%.2f"|format(payments_summary[person.id].balance) }}</span>
                                        <small class="balance-hint">Le deben</small>
                                    {% elif payments_summary[person.id].balance < 0 %}
                                        <span class="balance-negative">-${{ "%.2f"|format(payments_summary[person.id].balance|abs) }}</span>
                                        <small class="balance-hint">Debe</small>
                                    {% else %}
                                        <span class="balance-zero">$0.00</span>
                                        <small class="balance-hint">A mano</small>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <div class="payments-explanation">
                        <h4>üí° C√≥mo leer este resumen:</h4>
                        <ul>
                            <li><strong>Pag√≥:</strong> Dinero que esta persona desembols√≥ de su bolsillo</li>
                            <li><strong>Debe (Consumo):</strong> Total que le corresponde pagar seg√∫n su consumo</li>
                            <li><strong>Balance positivo (+):</strong> Esta persona pag√≥ de m√°s ‚Üí <strong>Le deben devolver ese dinero</strong></li>
                            <li><strong>Balance negativo (-):</strong> Esta persona consumi√≥ m√°s de lo que pag√≥ ‚Üí <strong>Debe ese dinero</strong></li>
                            <li><strong>Balance cero (A mano):</strong> Lo que pag√≥ = Lo que consumi√≥ ‚Üí No hay deuda</li>
                        </ul>
                    </div>
                </div>
                {% else %}
                    <p class="empty-message">Agrega personas y marca qui√©n pag√≥ los √≠tems para ver el resumen</p>
                {% endif %}
            </section>

            <!-- Acciones Generales -->
            <section class="actions-section">
                <form action="{{ url_for('clear_all', trip_id=current_trip.id) }}" method="POST" onsubmit="return confirm('¬øEst√°s seguro de que quieres limpiar todos los datos de este viaje?');">
                    <button type="submit" class="btn btn-warning">üóëÔ∏è Limpiar Todo</button>
                </form>
            </section>
        </div>
    </div>

    <!-- Loader Overlay -->
    <div class="loader-overlay" id="globalLoader">
        <div class="loader-container">
            <div class="loader-spinner"></div>
            <p class="loader-text">Cargando...</p>
        </div>
    </div>

    <script>
        // Funciones del Loader
        function showLoader(message = 'Cargando...') {
            const loader = document.getElementById('globalLoader');
            const loaderText = loader.querySelector('.loader-text');
            loaderText.textContent = message;
            loader.classList.add('show');
        }

        function hideLoader() {
            const loader = document.getElementById('globalLoader');
            loader.classList.remove('show');
        }

        // Mostrar loader autom√°ticamente en todos los formularios
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                // No aplicar loader a formularios de edici√≥n inline
                if (!form.classList.contains('edit-form')) {
                    form.addEventListener('submit', function(e) {
                        // Verificar si el formulario requiere confirmaci√≥n
                        const hasConfirm = form.getAttribute('onsubmit') && form.getAttribute('onsubmit').includes('confirm');
                        if (!hasConfirm) {
                            showLoader('Procesando...');
                        } else {
                            // Para formularios con confirmaci√≥n, mostrar loader solo si se confirma
                            const originalOnsubmit = form.getAttribute('onsubmit');
                            form.setAttribute('onsubmit', originalOnsubmit.replace('return confirm', 'if (confirm') + ') { showLoader("Procesando..."); return true; } return false;');
                        }
                    });
                }
            });
        });

        // Toggle chip de persona (pagado por)
        function toggleChip(chipElement) {
            const checkbox = chipElement.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            chipElement.classList.toggle('selected', checkbox.checked);
        }

        // Mostrar/ocultar formulario de edici√≥n de √≠tem
        function toggleEditItem(itemId) {
            const editRow = document.getElementById(`edit-row-${itemId}`);
            if (editRow.style.display === 'none') {
                editRow.style.display = 'table-row';
            } else {
                editRow.style.display = 'none';
            }
        }

        // Mostrar/ocultar formulario de edici√≥n de costo compartido
        function toggleEditShared(sharedId) {
            const editForm = document.getElementById(`edit-shared-${sharedId}`);
            if (editForm.style.display === 'none') {
                editForm.style.display = 'block';
            } else {
                editForm.style.display = 'none';
            }
        }

        // Sistema de pesta√±as
        function openDay(evt, dayId) {
            var tabContents = document.getElementsByClassName("tab-content");
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }

            var tabButtons = document.getElementsByClassName("tab-button");
            for (var i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }

            document.getElementById(dayId).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Alternar checkbox y actualizar SOLO los totales (sin recargar)
        async function togglePersonItem(itemId, personId, tripId) {
            showLoader('Actualizando...');
            try {
                const response = await fetch('{{ url_for("toggle_item_person") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId, person_id: personId, trip_id: tripId })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        // Actualizar resumen general
                        updateGeneralSummary(data.totals, data.grand_total, data.summary);

                        // Actualizar totales de cada d√≠a
                        if (data.days_totals) {
                            updateDaysSummaries(data.days_totals);
                        }
                        hideLoader();
                    } else {
                        location.reload();
                    }
                } else {
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                location.reload();
            }
        }

        // Actualizar resumen general
        function updateGeneralSummary(totals, grandTotal, summary) {
            // Actualizar tabla de totales
            for (const [personId, amounts] of Object.entries(totals)) {
                const cells = {
                    items: document.getElementById(`items-${personId}`),
                    shared: document.getElementById(`shared-${personId}`),
                    total: document.getElementById(`total-${personId}`)
                };

                if (cells.items) cells.items.textContent = `$${amounts.items_total.toFixed(2)}`;
                if (cells.shared) cells.shared.textContent = `$${amounts.shared_total.toFixed(2)}`;
                if (cells.total) cells.total.textContent = `$${amounts.total.toFixed(2)}`;
            }

            // Actualizar grand total
            const grandTotalCell = document.querySelector('.grand-total');
            if (grandTotalCell) grandTotalCell.textContent = `$${grandTotal.toFixed(2)}`;

            // Actualizar panel de verificaci√≥n
            if (summary) {
                const verificationValues = {
                    'Total √çtems': summary.total_items,
                    'Total Compartido': summary.total_shared,
                    'Total de Gastos': summary.grand_total,
                    'Total Distribuido': summary.total_distributed,
                    'Diferencia': summary.difference
                };

                document.querySelectorAll('.verification-item').forEach(item => {
                    const label = item.querySelector('.verification-label');
                    const value = item.querySelector('.verification-value');

                    if (label && value) {
                        for (const [key, val] of Object.entries(verificationValues)) {
                            if (label.textContent.includes(key)) {
                                value.textContent = `$${val.toFixed(2)}`;
                                if (key === 'Diferencia') {
                                    value.className = 'verification-value ' + (summary.is_balanced ? 'balanced' : 'unbalanced');
                                }
                            }
                        }
                    }
                });

                const panel = document.querySelector('.verification-panel');
                if (panel) panel.className = 'verification-panel ' + (summary.is_balanced ? 'verified' : 'warning');
            }
        }

        // Actualizar res√∫menes de cada d√≠a
        function updateDaysSummaries(daysTotals) {
            for (const [day, dayData] of Object.entries(daysTotals)) {
                // Actualizar total en la pesta√±a
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.textContent.includes(`D√≠a ${day}`)) {
                        const totalSpan = btn.querySelector('.tab-total');
                        if (totalSpan) totalSpan.textContent = `$${dayData.day_total.toFixed(2)}`;
                    }
                });

                // Actualizar tabla de resumen del d√≠a
                const dayContent = document.getElementById(`day${day}`);
                if (dayContent && dayData.totals) {
                    const table = dayContent.querySelector('.day-totals-table tbody');
                    if (table) {
                        const rows = table.querySelectorAll('tr');
                        let idx = 0;
                        for (const [personId, amounts] of Object.entries(dayData.totals)) {
                            if (rows[idx]) {
                                const cells = rows[idx].querySelectorAll('td');
                                if (cells.length >= 4) {
                                    cells[1].textContent = `$${amounts.items_total.toFixed(2)}`;
                                    cells[2].textContent = `$${amounts.shared_total.toFixed(2)}`;
                                    cells[3].textContent = `$${amounts.total.toFixed(2)}`;
                                }
                            }
                            idx++;
                        }
                    }

                    // Actualizar total del d√≠a en footer
                    const footer = dayContent.querySelector('.day-grand-total');
                    if (footer) footer.textContent = `$${dayData.day_total.toFixed(2)}`;
                }
            }
        }
    </script>
</body>
</html>

